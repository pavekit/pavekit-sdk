!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.PaveKit=e():t.PaveKit=e()}(Object("undefined"!=typeof self?self:this),function(){return function(){"use strict";var t={d:function(e,i){for(var s in i)t.o(i,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:i[s]})},o:function(t,e){return Object.prototype.hasOwnProperty.call(t,e)}},e={};t.d(e,{default:function(){return c}});var i=class{constructor(){this.SENSITIVE_PATTERNS=["password","passwd","pwd","pass","token","secret","key","auth","credit","card","cvv","cvc","ccv","ssn","social","security","pin","code","otp","bank","account","routing","license","passport","id_number","api_key","private","hidden"],this.SAFE_PATTERNS=["email","mail","e-mail","name","firstname","lastname","fullname","company","organization","org","phone","tel","telephone","mobile","website","url","domain","title","position","job","industry","category"],this.SAFE_INPUT_TYPES=["email","text","tel","url","search"],this.BLOCKED_INPUT_TYPES=["password","hidden","file"]}isSafeToCapture(t,e,i=null){if(!t&&!e)return!1;const s=(t||"").toLowerCase(),n=(e||"").toLowerCase();if(this.BLOCKED_INPUT_TYPES.includes(n))return!1;if(this.containsSensitivePattern(s))return!1;if(i){const t=(i.placeholder||"").toLowerCase();if(this.containsSensitivePattern(t))return!1;const e=(i.getAttribute("aria-label")||"").toLowerCase();if(this.containsSensitivePattern(e))return!1;const s=window.getComputedStyle(i);if("none"===s.display||"hidden"===s.visibility)return!1;const n=(i.getAttribute("autocomplete")||"").toLowerCase();if(n.includes("current-password")||n.includes("new-password")||n.includes("cc-number")||n.includes("cc-csc"))return!1}return!!this.SAFE_INPUT_TYPES.includes(n)||!!this.containsSafePattern(s)}containsSensitivePattern(t){if(!t)return!1;const e=t.toLowerCase();return this.SENSITIVE_PATTERNS.some(t=>e.includes(t))}containsSafePattern(t){if(!t)return!1;const e=t.toLowerCase();return this.SAFE_PATTERNS.some(t=>e.includes(t))}sanitizeFormData(t,e=null){const i={};return Object.keys(t).forEach(s=>{const n=t[s];if(!n||""===n.trim())return;let a=null;e&&(a=e.querySelector(`[name="${s}"], #${s}`));const r=a?a.type:null;this.isSafeToCapture(s,r,a)&&(this.isEmailField(s,r)?this.isValidEmail(n)&&(i[s]=this.sanitizeEmail(n)):i[s]=this.sanitizeText(n))}),i}isEmailField(t,e){const i=(t||"").toLowerCase();return"email"===(e||"").toLowerCase()||i.includes("email")||i.includes("mail")}isValidEmail(t){return/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(t)}sanitizeEmail(t){return t.toLowerCase().trim()}sanitizeText(t){return t.trim().substring(0,255)}hashSensitiveData(t){let e=0;if(!t||0===t.length)return e.toString();for(let i=0;i<t.length;i++){e=(e<<5)-e+t.charCodeAt(i),e&=e}return Math.abs(e).toString(36)}isSafeURL(t=window.location.href){const e=t.toLowerCase();return!["password","reset","forgot","payment","checkout","billing","admin","dashboard","settings","profile","account"].some(t=>e.includes(t))}extractSafePageData(){return{url:this.isSafeURL()?window.location.href:"[filtered]",title:document.title||"",referrer:this.isSafeURL(document.referrer)?document.referrer:"[filtered]",timestamp:(new Date).toISOString(),userAgent:navigator.userAgent}}isBrowserSupported(){return!!(window.fetch&&window.Promise&&window.addEventListener&&document.querySelector)}getComplianceInfo(){return{gdpr_compliant:!0,data_minimization:!0,no_sensitive_data:!0,user_consent_required:!0,opt_out_available:!0,data_retention_limited:!0}}};var s=class{constructor(){this.baseURL="http://localhost:8000",this.apiKey=null,this.timeout=5e3,this.retryAttempts=3,this.retryDelay=1e3}init(t){this.apiKey=t.apiKey,this.baseURL=t.baseURL||this.baseURL,this.timeout=t.timeout||this.timeout,t.debug}async makeRequest(t,e={}){const i=`${this.baseURL}/api/onboarding/sdk${t}`,s={method:"POST",headers:{"Content-Type":"application/json","X-API-Key":this.apiKey,...e.headers},...e},n=new AbortController,a=setTimeout(()=>n.abort(),this.timeout);s.signal=n.signal;let r=null;for(let t=1;t<=this.retryAttempts;t++)try{const t=await fetch(i,s);if(clearTimeout(a),t.ok)return await t.json();const e=await t.text();throw new Error(`HTTP ${t.status}: ${e}`)}catch(e){if(clearTimeout(a),r=e,"AbortError"===e.name||e.message&&e.message.includes("401"))throw e;t<this.retryAttempts&&await this.delay(this.retryDelay*t)}throw r}async registerSignup(t){if(!this.apiKey)throw new Error("API key not configured");if(!t.email)throw new Error("Email is required for signup registration");const e={email:t.email,signup_method:t.signup_method||"form",page_url:t.page_url||window.location.href,referrer:t.referrer||document.referrer,user_agent:navigator.userAgent,metadata:t.metadata||{}};try{return await this.makeRequest("/signup",{method:"POST",body:JSON.stringify(e)})}catch(t){throw t}}async trackActivity(t){if(!this.apiKey||!t.email)return;const e={email:t.email,page_url:t.page_url||window.location.href,timestamp:(new Date).toISOString()};try{return await this.makeRequest("/activity",{method:"POST",body:JSON.stringify(e)})}catch(t){}}async updateUser(t){if(!this.apiKey)throw new Error("API key not configured");if(!t.email)throw new Error("Email is required to update user info");const e={email:t.email,name:t.name||""};try{return await this.makeRequest("/user-info",{method:"POST",body:JSON.stringify(e)})}catch(t){throw t}}async trackConversion(t){if(!this.apiKey)throw new Error("API key not configured");if(!t.email)throw new Error("Email is required for conversion tracking");const e={email:t.email,conversion_type:t.conversion_type||"purchase",value:t.value||0,currency:t.currency||"USD",metadata:t.metadata||{}};try{return await this.makeRequest("/conversion",{method:"POST",body:JSON.stringify(e)})}catch(t){throw t}}async validateAPIKey(){if(!this.apiKey)throw new Error("API key not configured");try{return await this.makeRequest("/validate",{method:"GET"})}catch(t){throw t}}async sendBatch(t){if(!this.apiKey||!t||0===t.length)return;const e={events:t,batch_timestamp:(new Date).toISOString()};try{return await this.makeRequest("/batch",{method:"POST",body:JSON.stringify(e)})}catch(t){throw t}}async getConfig(){if(!this.apiKey)throw new Error("API key not configured");try{return await this.makeRequest("/config",{method:"GET"})}catch(t){return{}}}async testConnection(){try{return await this.validateAPIKey(),!0}catch(t){return!1}}delay(t){return new Promise(e=>setTimeout(e,t))}getStatus(){return{initialized:!!this.apiKey,baseURL:this.baseURL,hasConnection:!0,lastError:null}}updateConfig(t){t.baseURL&&(this.baseURL=t.baseURL),t.timeout&&(this.timeout=t.timeout),t.retryAttempts&&(this.retryAttempts=t.retryAttempts),t.retryDelay&&(this.retryDelay=t.retryDelay)}reset(){this.apiKey=null,this.baseURL="http://localhost:8000",this.timeout=5e3,this.retryAttempts=3,this.retryDelay=1e3}};var n=class{constructor(){this.consentKey="pavekit_consent",this.optOutKey="pavekit_opt_out",this.hasUserConsent=!1,this.isOptedOut=!1,this.consentTimestamp=null,this.consentVersion="1.0",this.loadConsentStatus()}loadConsentStatus(){try{const t=localStorage.getItem(this.consentKey),e=localStorage.getItem(this.optOutKey);if(t){const e=JSON.parse(t);this.hasUserConsent=e.granted||!1,this.consentTimestamp=e.timestamp,this.consentVersion=e.version||"1.0"}this.isOptedOut="true"===e}catch(t){this.hasUserConsent=!1,this.isOptedOut=!1}}saveConsentStatus(){try{const t={granted:this.hasUserConsent,timestamp:this.consentTimestamp,version:this.consentVersion};localStorage.setItem(this.consentKey,JSON.stringify(t)),localStorage.setItem(this.optOutKey,this.isOptedOut.toString())}catch(t){}}hasConsent(){return this.hasUserConsent&&!this.isOptedOut&&!this.isDoNotTrackEnabled()}isDoNotTrackEnabled(){return"1"===navigator.doNotTrack||"1"===navigator.msDoNotTrack||"1"===window.doNotTrack}async requestConsent(t={}){if(this.hasUserConsent||this.isOptedOut)return this.hasConsent();if(this.isDoNotTrackEnabled())return!1;return!1!==t.showBanner?await this.showConsentBanner(t):this.grantConsent("implicit")}async showConsentBanner(t={}){return new Promise(e=>{if(document.getElementById("pavekit-consent-banner"))return void e(this.hasConsent());const i=this.createConsentBanner(t);document.body.appendChild(i);const s=t=>{document.body.removeChild(i),t?this.grantConsent("explicit"):this.denyConsent(),e(this.hasConsent())};i.querySelector("#pavekit-consent-accept").onclick=()=>s(!0),i.querySelector("#pavekit-consent-decline").onclick=()=>s(!1),t.timeout&&setTimeout(()=>{document.body.contains(i)&&s(!1)},t.timeout)})}createConsentBanner(t={}){const e=document.createElement("div");e.id="pavekit-consent-banner",e.style.cssText="\n      position: fixed;\n      bottom: 0;\n      left: 0;\n      right: 0;\n      background: #2c3e50;\n      color: white;\n      padding: 15px 20px;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui;\n      font-size: 14px;\n      z-index: 999999;\n      box-shadow: 0 -2px 10px rgba(0,0,0,0.1);\n      display: flex;\n      align-items: center;\n      justify-content: space-between;\n      flex-wrap: wrap;\n    ";const i=t.message||"We use cookies and collect minimal data to improve your experience and send relevant onboarding emails. By continuing, you agree to our data collection practices.",s=t.privacyUrl||"#";return e.innerHTML=`\n      <div style="flex: 1; margin-right: 20px; min-width: 300px;">\n        <span>${i}</span>\n        <a href="${s}" target="_blank" style="color: #3498db; text-decoration: underline; margin-left: 5px;">\n          Privacy Policy\n        </a>\n      </div>\n      <div style="display: flex; gap: 10px; flex-wrap: wrap;">\n        <button id="pavekit-consent-decline" style="\n          background: transparent;\n          border: 1px solid #95a5a6;\n          color: #95a5a6;\n          padding: 8px 16px;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 12px;\n        ">\n          Decline\n        </button>\n        <button id="pavekit-consent-accept" style="\n          background: #27ae60;\n          border: none;\n          color: white;\n          padding: 8px 16px;\n          border-radius: 4px;\n          cursor: pointer;\n          font-size: 12px;\n        ">\n          Accept\n        </button>\n      </div>\n    `,e}grantConsent(t="explicit"){return this.hasUserConsent=!0,this.isOptedOut=!1,this.consentTimestamp=(new Date).toISOString(),this.saveConsentStatus(),this.dispatchConsentEvent("granted",{type:t,timestamp:this.consentTimestamp}),!0}denyConsent(){return this.hasUserConsent=!1,this.isOptedOut=!1,this.consentTimestamp=(new Date).toISOString(),this.saveConsentStatus(),this.dispatchConsentEvent("denied",{timestamp:this.consentTimestamp}),!1}optOut(){this.hasUserConsent=!1,this.isOptedOut=!0,this.consentTimestamp=(new Date).toISOString(),this.saveConsentStatus(),this.clearStoredData(),this.dispatchConsentEvent("opted-out",{timestamp:this.consentTimestamp})}async optIn(){return this.isOptedOut=!1,this.saveConsentStatus(),await this.requestConsent()}clearStoredData(){try{localStorage.removeItem(this.consentKey),localStorage.removeItem(this.optOutKey),Object.keys(localStorage).forEach(t=>{t.startsWith("pavekit_")&&localStorage.removeItem(t)}),Object.keys(sessionStorage).forEach(t=>{t.startsWith("pavekit_")&&sessionStorage.removeItem(t)})}catch(t){}}dispatchConsentEvent(t,e={}){try{const i=new CustomEvent("pavekit-consent",{detail:{type:t,...e}});window.dispatchEvent(i)}catch(t){}}getConsentStatus(){return{hasConsent:this.hasConsent(),isOptedOut:this.isOptedOut,consentTimestamp:this.consentTimestamp,consentVersion:this.consentVersion,doNotTrack:this.isDoNotTrackEnabled()}}isConsentRequired(){return!0}getAnonymousId(){let t=localStorage.getItem("pavekit_anonymous_id");if(!t){t="anon_"+Date.now()+"_"+Math.random().toString(36).substr(2,9);try{localStorage.setItem("pavekit_anonymous_id",t)}catch(e){t="session_"+Date.now()}}return t}reset(){this.clearStoredData(),this.hasUserConsent=!1,this.isOptedOut=!1,this.consentTimestamp=null,this.consentVersion="1.0"}getDataRetentionInfo(){return{consentData:"2 years",analyticsData:"26 months",emailData:"Until unsubscribe or opt-out",rightToErasure:"Available on request",dataController:"PaveKit Platform"}}};var a=class{constructor(t,e,i){this.securityUtils=t,this.apiClient=e,this.privacyManager=i,this.isActive=!1,this.detectedForms=new Set,this.processedSubmissions=new Set,this.config={debounceDelay:500,maxFormsToMonitor:10,requireEmailField:!0,autoDetect:!0}}start(t={}){this.isActive||(this.config={...this.config,...t},this.isActive=!0,this.config.autoDetect&&(this.scanForForms(),this.attachDOMObserver()),this.attachGlobalFormListener())}stop(){this.isActive&&(this.isActive=!1,this.detachGlobalFormListener(),this.detachDOMObserver(),this.detectedForms.clear(),this.processedSubmissions.clear())}scanForForms(){document.querySelectorAll("form").forEach(t=>{this.detectedForms.size>=this.config.maxFormsToMonitor||this.isSignupForm(t)&&this.monitorForm(t)})}attachDOMObserver(){this.domObserver||(this.domObserver=new MutationObserver(t=>{t.forEach(t=>{t.addedNodes.forEach(t=>{if(t.nodeType===Node.ELEMENT_NODE){"FORM"===t.tagName&&this.isSignupForm(t)&&this.monitorForm(t);(t.querySelectorAll?t.querySelectorAll("form"):[]).forEach(t=>{this.detectedForms.size<this.config.maxFormsToMonitor&&this.isSignupForm(t)&&this.monitorForm(t)})}})})}),this.domObserver.observe(document.body,{childList:!0,subtree:!0}))}detachDOMObserver(){this.domObserver&&(this.domObserver.disconnect(),this.domObserver=null)}attachGlobalFormListener(){this.formSubmitHandler=this.handleFormSubmit.bind(this),document.addEventListener("submit",this.formSubmitHandler,!0)}detachGlobalFormListener(){this.formSubmitHandler&&(document.removeEventListener("submit",this.formSubmitHandler,!0),this.formSubmitHandler=null)}async handleFormSubmit(t){if(!this.isActive||!this.privacyManager.hasConsent())return;const e=t.target;if(!e||"FORM"!==e.tagName)return;const i=this.getSubmissionId(e);this.processedSubmissions.has(i)||this.isSignupForm(e)&&(this.processedSubmissions.add(i),setTimeout(()=>{this.processedSubmissions.delete(i)},this.config.debounceDelay),await this.processSignupForm(e))}getSubmissionId(t){new FormData(t);const e=this.extractEmailFromForm(t),i=Date.now();return`${t.action||window.location.href}_${e}_${i}`}isSignupForm(t){if(!t||"FORM"!==t.tagName)return!1;const e=this.hasEmailField(t);if(this.config.requireEmailField&&!e)return!1;const i=`${(t.action||"").toLowerCase()} ${(t.id||"").toLowerCase()} ${(t.className||"").toLowerCase()}`.toLowerCase();if(["login","signin","sign-in","password","reset","forgot","recover","search","newsletter","contact","comment","review","feedback","support"].some(t=>i.includes(t)))return!1;const s=["signup","sign-up","register","registration","join","create","account","member"].some(t=>i.includes(t)),n=null!==t.querySelector('input[type="password"]'),a=t.querySelectorAll('input[type="text"], input[type="email"]').length;return e&&(s||n&&a>=2||this.hasSignupButtons(t))}hasEmailField(t){if(t.querySelectorAll('input[type="email"]').length>0)return!0;return t.querySelectorAll('input[name*="email"], input[id*="email"], input[name*="mail"], input[id*="mail"]').length>0}hasSignupButtons(t){const e=t.querySelectorAll('button, input[type="submit"]');return Array.from(e).some(t=>{const e=(t.textContent||t.value||"").toLowerCase();return["signup","sign up","register","join","create account"].some(t=>e.includes(t))})}monitorForm(t){this.detectedForms.has(t)||(this.detectedForms.add(t),this.config.debug&&(t.style.outline="2px dashed #27ae60",t.title="PaveKit: Monitoring this signup form"))}async processSignupForm(t){try{const e=this.extractEmailFromForm(t);if(!e||!this.securityUtils.isValidEmail(e))return;const i=this.extractSafeData(t),s={email:e,signup_method:"form",page_url:window.location.href,referrer:document.referrer,form_data:i,metadata:{form_action:t.action||"",form_method:t.method||"get",detected_at:(new Date).toISOString()}};await this.apiClient.registerSignup(s)}catch(t){}}extractEmailFromForm(t){const e=t.querySelector('input[type="email"]');if(e&&e.value)return e.value.trim();const i=['input[name*="email" i]','input[id*="email" i]','input[name*="mail" i]','input[id*="mail" i]'];for(const e of i){const i=t.querySelector(e);if(i&&i.value&&this.securityUtils.isValidEmail(i.value))return i.value.trim()}return null}extractSafeData(t){const e={};return new FormData(t).forEach((i,s)=>{if(!i||""===i.trim())return;const n=t.querySelector(`[name="${s}"]`),a=n?n.type:null;this.securityUtils.isSafeToCapture(s,a,n)&&(e[s]=this.securityUtils.sanitizeText(i))}),e}getStatus(){return{isActive:this.isActive,detectedForms:this.detectedForms.size,processedSubmissions:this.processedSubmissions.size,config:this.config}}updateConfig(t){this.config={...this.config,...t},this.isActive&&(this.stop(),this.start(this.config))}getDetectedForms(){return Array.from(this.detectedForms).map(t=>({id:t.id||null,className:t.className||null,action:t.action||null,method:t.method||"get",fieldCount:t.querySelectorAll("input").length,hasEmailField:this.hasEmailField(t),hasPasswordField:null!==t.querySelector('input[type="password"]')}))}};var r=class{constructor(t,e,i){this.securityUtils=t,this.apiClient=e,this.privacyManager=i,this.isActive=!1,this.config={checkInterval:1e3,maxChecks:30,cleanupDelay:5e3,supportedProviders:["google","github","microsoft","facebook","twitter"]},this.checkCount=0,this.intervalId=null,this.detectedFlows=new Set}start(t={}){this.isActive||(this.config={...this.config,...t},this.isActive=!0,this.checkCount=0,this.checkForOAuthReturn(),this.intervalId=setInterval(()=>{this.checkForOAuthReturn(),this.checkCount++,this.checkCount>=this.config.maxChecks&&this.stopPeriodicChecking()},this.config.checkInterval),this.attachURLChangeListener())}stop(){this.isActive&&(this.isActive=!1,this.stopPeriodicChecking(),this.detachURLChangeListener(),this.detectedFlows.clear())}stopPeriodicChecking(){this.intervalId&&(clearInterval(this.intervalId),this.intervalId=null)}attachURLChangeListener(){this.originalPushState=history.pushState,this.originalReplaceState=history.replaceState;const t=this;history.pushState=function(){t.originalPushState.apply(history,arguments),setTimeout(()=>t.checkForOAuthReturn(),100)},history.replaceState=function(){t.originalReplaceState.apply(history,arguments),setTimeout(()=>t.checkForOAuthReturn(),100)},window.addEventListener("popstate",()=>{setTimeout(()=>this.checkForOAuthReturn(),100)})}detachURLChangeListener(){this.originalPushState&&(history.pushState=this.originalPushState),this.originalReplaceState&&(history.replaceState=this.originalReplaceState)}async checkForOAuthReturn(){if(!this.isActive)return;if(!this.privacyManager.hasConsent())return;const t=window.location.href,e=new URLSearchParams(window.location.search),i=new URLSearchParams(window.location.hash.substring(1)),s=this.generateFlowId(t);if(this.detectedFlows.has(s))return;const n=this.detectOAuthFlow(e,i);n.isOAuthReturn&&(this.detectedFlows.add(s),await this.processOAuthReturn(n),setTimeout(()=>{this.cleanOAuthParams()},this.config.cleanupDelay))}generateFlowId(t){return`${t.replace(/[?&](code|access_token|id_token)=[^&]*/g,"").replace(/[?&](state|scope)=[^&]*/g,"")}_${Date.now()}`}detectOAuthFlow(t,e){const i={isOAuthReturn:!1,provider:null,flowType:null,hasError:!1,errorDescription:null,state:null};t.get("code")&&(i.isOAuthReturn=!0,i.flowType="authorization_code",i.state=t.get("state"));const s=e.get("access_token")||t.get("access_token"),n=e.get("id_token")||t.get("id_token");(s||n)&&(i.isOAuthReturn=!0,i.flowType="implicit",i.state=e.get("state")||t.get("state"));return(t.get("error")||e.get("error"))&&(i.isOAuthReturn=!0,i.hasError=!0,i.errorDescription=t.get("error_description")||e.get("error_description")),i.isOAuthReturn&&(i.provider=this.detectOAuthProvider()),i.isOAuthReturn&&(i.isOAuthReturn=this.validateOAuthReturn()),i}detectOAuthProvider(){const t=document.referrer.toLowerCase(),e=window.location.href.toLowerCase(),i={google:["accounts.google.com","googleapis.com","google.com/oauth"],github:["github.com","api.github.com"],microsoft:["login.microsoftonline.com","login.live.com","outlook.com"],facebook:["facebook.com","fb.com"],twitter:["twitter.com","api.twitter.com"],linkedin:["linkedin.com","api.linkedin.com"],apple:["appleid.apple.com"]};for(const[e,s]of Object.entries(i))if(s.some(e=>t.includes(e)))return e;for(const[t,s]of Object.entries(i))if(s.some(t=>e.includes(t)))return t;const s=new URLSearchParams(window.location.search).get("state");if(s){const t=s.toLowerCase();for(const e of Object.keys(i))if(t.includes(e))return e}return"unknown"}validateOAuthReturn(){const t=document.referrer.toLowerCase(),e=this.config.supportedProviders.some(e=>t.includes(e)||t.includes("oauth")||t.includes("auth")),i=window.location.href.toLowerCase(),s=i.includes("callback")||i.includes("redirect")||i.includes("auth")||i.includes("oauth"),n=performance.getEntriesByType("navigation")[0],a=n&&Date.now()-n.loadEventStart<1e4;return e||s||a}async processOAuthReturn(t){if(!t.hasError)try{const e={email:await this.extractEmailFromPage()||"oauth_user@pending.com",signup_method:`oauth_${t.provider}`,page_url:window.location.href,referrer:document.referrer,metadata:{oauth_provider:t.provider,oauth_flow_type:t.flowType,oauth_state:t.state,detected_at:(new Date).toISOString(),user_agent:navigator.userAgent}};await this.apiClient.registerSignup(e)}catch(t){}}async extractEmailFromPage(){await this.delay(1e3);const t=["[data-email]",".email",".user-email",".account-email",'input[type="email"][value]','[class*="email" i]:not([type="password"])','[id*="email" i]:not([type="password"])'];for(const e of t){const t=document.querySelectorAll(e);for(const e of t){const t=this.extractEmailFromElement(e);if(t&&this.securityUtils.isValidEmail(t))return t}}const e=(document.body.textContent||"").match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/g);if(e&&e.length>0)for(const t of e)if(this.securityUtils.isValidEmail(t))return t;return null}extractEmailFromElement(t){if(t.dataset&&t.dataset.email)return t.dataset.email;if(t.value)return t.value;if(t.textContent){const e=t.textContent.trim();if(this.securityUtils.isValidEmail(e))return e}return null}cleanOAuthParams(){if(!this.isActive)return;const t=new URL(window.location.href),e=t.searchParams;let i=!1;if(["code","access_token","id_token","refresh_token","token_type","expires_in","scope"].forEach(t=>{e.has(t)&&(e.delete(t),i=!0)}),(window.location.hash.includes("access_token")||window.location.hash.includes("id_token"))&&(t.hash="",i=!0),i){const e=t.toString();history.replaceState({},document.title,e)}}delay(t){return new Promise(e=>setTimeout(e,t))}getStatus(){return{isActive:this.isActive,checkCount:this.checkCount,detectedFlows:this.detectedFlows.size,config:this.config,intervalActive:!!this.intervalId}}updateConfig(t){this.config={...this.config,...t},this.isActive&&(this.stop(),this.start(this.config))}getDetectedFlows(){return Array.from(this.detectedFlows).map(t=>({flowId:t,detectedAt:(new Date).toISOString(),url:window.location.href}))}async manualDetection(){const t=new URLSearchParams(window.location.search),e=new URLSearchParams(window.location.hash.substring(1));return this.detectOAuthFlow(t,e)}};var o=class{constructor(t,e,i){this.securityUtils=t,this.apiClient=e,this.privacyManager=i,this.isActive=!1,this.config={heartbeatInterval:3e5,minActivityDuration:3e4,trackScroll:!0,trackClicks:!0,trackTimeOnPage:!0,trackPageVisibility:!0,maxInactivityTime:9e5,debounceDelay:1e3},this.sessionData={startTime:null,lastActivity:null,totalActiveTime:0,pageViews:0,scrollDepth:0,clickCount:0,userEmail:null,isVisible:!0},this.intervals={},this.eventHandlers={},this.lastHeartbeat=null,this.inactivityTimer=null}start(t={},e=null){this.isActive||(this.config={...this.config,...t},this.sessionData.userEmail=e,this.isActive=!0,this.initializeSession(),this.attachEventListeners(),this.startHeartbeat(),this.startInactivityTimer())}stop(){this.isActive&&(this.isActive=!1,this.detachEventListeners(),this.stopHeartbeat(),this.stopInactivityTimer(),this.sendFinalActivity())}initializeSession(){const t=Date.now();this.sessionData.startTime=t,this.sessionData.lastActivity=t,this.sessionData.pageViews=1,this.sessionData.isVisible=!document.hidden,this.loadSessionData()}loadSessionData(){try{const t=sessionStorage.getItem("pavekit_activity_session");if(t){const e=JSON.parse(t);Date.now()-e.lastActivity<this.config.maxInactivityTime&&(this.sessionData.totalActiveTime+=e.totalActiveTime||0,this.sessionData.pageViews+=e.pageViews||0,this.sessionData.clickCount+=e.clickCount||0,this.sessionData.scrollDepth=Math.max(this.sessionData.scrollDepth,e.scrollDepth||0))}}catch(t){}}saveSessionData(){try{sessionStorage.setItem("pavekit_activity_session",JSON.stringify({...this.sessionData,savedAt:Date.now()}))}catch(t){}}attachEventListeners(){this.config.trackPageVisibility&&(this.eventHandlers.visibilityChange=this.handleVisibilityChange.bind(this),document.addEventListener("visibilitychange",this.eventHandlers.visibilityChange)),this.config.trackScroll&&(this.eventHandlers.scroll=this.debounce(this.handleScroll.bind(this),this.config.debounceDelay),window.addEventListener("scroll",this.eventHandlers.scroll,{passive:!0})),this.config.trackClicks&&(this.eventHandlers.click=this.handleClick.bind(this),document.addEventListener("click",this.eventHandlers.click,!0)),this.eventHandlers.mouseMove=this.debounce(this.updateActivity.bind(this),this.config.debounceDelay),document.addEventListener("mousemove",this.eventHandlers.mouseMove,{passive:!0}),this.eventHandlers.keyPress=this.debounce(this.updateActivity.bind(this),this.config.debounceDelay),document.addEventListener("keydown",this.eventHandlers.keyPress,{passive:!0}),this.eventHandlers.beforeUnload=this.handleBeforeUnload.bind(this),window.addEventListener("beforeunload",this.eventHandlers.beforeUnload),this.eventHandlers.focus=this.updateActivity.bind(this),this.eventHandlers.blur=this.handleBlur.bind(this),window.addEventListener("focus",this.eventHandlers.focus),window.addEventListener("blur",this.eventHandlers.blur)}detachEventListeners(){this.eventHandlers.visibilityChange&&document.removeEventListener("visibilitychange",this.eventHandlers.visibilityChange),this.eventHandlers.scroll&&window.removeEventListener("scroll",this.eventHandlers.scroll),this.eventHandlers.click&&document.removeEventListener("click",this.eventHandlers.click,!0),this.eventHandlers.mouseMove&&document.removeEventListener("mousemove",this.eventHandlers.mouseMove),this.eventHandlers.keyPress&&document.removeEventListener("keydown",this.eventHandlers.keyPress),this.eventHandlers.beforeUnload&&window.removeEventListener("beforeunload",this.eventHandlers.beforeUnload),this.eventHandlers.focus&&window.removeEventListener("focus",this.eventHandlers.focus),this.eventHandlers.blur&&window.removeEventListener("blur",this.eventHandlers.blur),this.eventHandlers={}}handleVisibilityChange(){const t=!document.hidden;t&&!this.sessionData.isVisible?(this.sessionData.isVisible=!0,this.updateActivity(),this.startHeartbeat()):!t&&this.sessionData.isVisible&&(this.sessionData.isVisible=!1,this.stopHeartbeat(),this.sendActivityUpdate())}handleScroll(){if(!this.config.trackScroll||!this.sessionData.isVisible)return;const t=window.pageYOffset||document.documentElement.scrollTop,e=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight),i=window.innerHeight,s=Math.round((t+i)/e*100);this.sessionData.scrollDepth=Math.max(this.sessionData.scrollDepth,s),this.updateActivity()}handleClick(t){if(!this.config.trackClicks||!this.sessionData.isVisible)return;const e=t.target;this.isSafeClickTarget(e)&&(this.sessionData.clickCount++,this.updateActivity())}isSafeClickTarget(t){if(!t||!t.tagName)return!1;const e=t.tagName.toLowerCase(),i=`${(t.className||"").toLowerCase()} ${(t.id||"").toLowerCase()}`.toLowerCase();if(["password","hidden","token","key","secret"].some(t=>i.includes(t)))return!1;return["a","button","span","div","p","h1","h2","h3","h4","h5","h6"].includes(e)}handleBlur(){this.stopHeartbeat(),this.sendActivityUpdate()}handleBeforeUnload(){this.sendFinalActivity(),this.saveSessionData()}updateActivity(){const t=Date.now();if(this.sessionData.lastActivity){const e=t-this.sessionData.lastActivity;e<this.config.maxInactivityTime&&(this.sessionData.totalActiveTime+=e)}this.sessionData.lastActivity=t,this.restartInactivityTimer()}startHeartbeat(){this.intervals.heartbeat||(this.intervals.heartbeat=setInterval(()=>{this.sessionData.isVisible&&this.privacyManager.hasConsent()&&this.sendActivityUpdate()},this.config.heartbeatInterval))}stopHeartbeat(){this.intervals.heartbeat&&(clearInterval(this.intervals.heartbeat),this.intervals.heartbeat=null)}startInactivityTimer(){this.restartInactivityTimer()}restartInactivityTimer(){this.inactivityTimer&&clearTimeout(this.inactivityTimer),this.inactivityTimer=setTimeout(()=>{this.handleInactivity()},this.config.maxInactivityTime)}stopInactivityTimer(){this.inactivityTimer&&(clearTimeout(this.inactivityTimer),this.inactivityTimer=null)}handleInactivity(){this.stopHeartbeat(),this.sendActivityUpdate()}async sendActivityUpdate(){if(this.privacyManager.hasConsent()&&this.sessionData.userEmail&&!(this.sessionData.totalActiveTime<this.config.minActivityDuration))try{const t={email:this.sessionData.userEmail,page_url:this.securityUtils.isSafeURL()?window.location.href:"[filtered]",activity_data:{time_on_page:Math.round(this.sessionData.totalActiveTime/1e3),scroll_depth:this.sessionData.scrollDepth,click_count:this.sessionData.clickCount,page_views:this.sessionData.pageViews,is_visible:this.sessionData.isVisible,session_duration:Date.now()-this.sessionData.startTime}};await this.apiClient.trackActivity(t),this.lastHeartbeat=Date.now(),this.saveSessionData()}catch(t){}}async sendFinalActivity(){this.updateActivity(),await this.sendActivityUpdate()}setUserEmail(t){this.securityUtils.isValidEmail(t)&&(this.sessionData.userEmail=t)}getActivityStats(){return this.updateActivity(),{sessionDuration:Date.now()-this.sessionData.startTime,activeTime:this.sessionData.totalActiveTime,scrollDepth:this.sessionData.scrollDepth,clickCount:this.sessionData.clickCount,pageViews:this.sessionData.pageViews,isActive:this.isActive,isVisible:this.sessionData.isVisible,lastActivity:this.sessionData.lastActivity,lastHeartbeat:this.lastHeartbeat}}getStatus(){return{isActive:this.isActive,hasUserEmail:!!this.sessionData.userEmail,isVisible:this.sessionData.isVisible,heartbeatActive:!!this.intervals.heartbeat,lastHeartbeat:this.lastHeartbeat,config:this.config,activityStats:this.getActivityStats()}}updateConfig(t){this.config={...this.config,...t},this.isActive&&t.heartbeatInterval&&this.intervals.heartbeat&&(this.stopHeartbeat(),this.startHeartbeat())}debounce(t,e){let i;return function(...s){clearTimeout(i),i=setTimeout(()=>t.apply(this,s),e)}}resetSession(){this.sessionData={startTime:Date.now(),lastActivity:Date.now(),totalActiveTime:0,pageViews:1,scrollDepth:0,clickCount:0,userEmail:this.sessionData.userEmail,isVisible:!document.hidden},this.saveSessionData()}pause(){this.isActive&&(this.stopHeartbeat(),this.sendActivityUpdate())}resume(){this.isActive&&(this.updateActivity(),this.startHeartbeat())}};class PaveKitSDK{constructor(){this.version="1.0.0",this.initialized=!1,this.offlineMode=!1,this.config={apiKey:null,baseURL:"http://localhost:8000",domain:null,detect:["signups","activity"],privacy:"gdpr-compliant",debug:!1,autoCleanup:!0,consentBanner:!0},this.securityUtils=new i,this.apiClient=new s,this.privacyManager=new n,this.detectors={form:null,oauth:null,activity:null},this.isDetecting=!1,this.userEmail=null}static autoInit(){if("undefined"==typeof window)return null;const t=document.querySelector('script[src*="pavekit"]');if(!t)return null;const e={apiKey:t.dataset.key,domain:t.dataset.domain,detect:t.dataset.detect?t.dataset.detect.split(","):["signups","activity"],privacy:t.dataset.privacy||"gdpr-compliant",debug:"true"===t.dataset.debug,baseURL:t.dataset.baseUrl||"http://localhost:8000",consentBanner:"false"!==t.dataset.consentBanner};if(!e.apiKey)return null;const i=new PaveKitSDK;return i.init(e),window.PaveKit=i,i}async init(t={}){if(!this.initialized){if(this.config={...this.config,...t},this.config.debug,!this.config.apiKey)throw new Error("PaveKit SDK: API key is required");if(this.securityUtils.isBrowserSupported())try{this.apiClient.init({apiKey:this.config.apiKey,baseURL:this.config.baseURL,debug:this.config.debug});let t=!1;try{await this.validateConfiguration(),t=!0,this.config.debug}catch(t){this.config.debug}this.initializeDetectors(),await this.handlePrivacyConsent(),this.initialized=!0,this.offlineMode=!t,this.config.debug,this.dispatchEvent("initialized",{version:this.version,config:this.config,offlineMode:this.offlineMode})}catch(t){throw t}}}async validateConfiguration(){const t=await this.apiClient.validateAPIKey();return this.config.debug,t}initializeDetectors(){this.detectors.form=new a(this.securityUtils,this.apiClient,this.privacyManager),this.detectors.oauth=new r(this.securityUtils,this.apiClient,this.privacyManager),this.detectors.activity=new o(this.securityUtils,this.apiClient,this.privacyManager),this.config.debug}async handlePrivacyConsent(){if(this.privacyManager.isConsentRequired()&&this.config.consentBanner){if(!await this.privacyManager.requestConsent({showBanner:!0,timeout:3e4,message:"We use cookies and collect minimal data to improve your experience and send relevant onboarding emails.",privacyUrl:"/privacy"}))return}else this.privacyManager.hasConsent()||this.privacyManager.grantConsent("implicit");this.privacyManager.hasConsent()&&this.startDetection()}startDetection(){if(this.isDetecting||!this.privacyManager.hasConsent())return;this.isDetecting=!0;const t={debug:this.config.debug};this.config.detect.includes("signups")&&this.detectors.form&&this.detectors.form.start(t),this.config.detect.includes("oauth")&&this.detectors.oauth&&this.detectors.oauth.start(t),this.config.detect.includes("activity")&&this.detectors.activity&&this.detectors.activity.start(t,this.userEmail),this.config.debug,this.dispatchEvent("detectionStarted",{detectors:this.config.detect})}stopDetection(){this.isDetecting&&(this.isDetecting=!1,Object.values(this.detectors).forEach(t=>{t&&t.stop&&t.stop()}),this.config.debug,this.dispatchEvent("detectionStopped"))}async trackSignup(t={}){if(!this.initialized||!this.privacyManager.hasConsent())throw new Error("SDK not initialized or consent not granted");const e={email:t.email||this.userEmail,signup_method:t.method||"manual",page_url:t.pageUrl||window.location.href,referrer:t.referrer||document.referrer,metadata:t.metadata||{}};if(!e.email)throw new Error("Email is required for signup tracking");try{const t=await this.apiClient.registerSignup(e);return this.config.debug,this.setUserEmail(e.email),t}catch(t){throw t}}async updateUser(t={}){if(!this.initialized||!this.privacyManager.hasConsent())throw new Error("SDK not initialized or consent not granted");const e={email:t.email||this.userEmail,name:t.name||""};if(!e.email)throw new Error("Email is required to update user info");try{const t=await this.apiClient.updateUser(e);return this.config.debug,t}catch(t){throw t}}async trackConversion(t={}){if(!this.initialized||!this.privacyManager.hasConsent())throw new Error("SDK not initialized or consent not granted");const e={email:t.email||this.userEmail,conversion_type:t.type||"purchase",value:t.value||0,currency:t.currency||"USD",metadata:t.metadata||{}};if(!e.email)throw new Error("Email is required for conversion tracking");try{const t=await this.apiClient.trackConversion(e);return this.config.debug,t}catch(t){throw t}}setUserEmail(t){if(!this.securityUtils.isValidEmail(t))throw new Error("Invalid email address");this.userEmail=t,this.detectors.activity&&this.detectors.activity.setUserEmail(t),this.config.debug}getConsentStatus(){return this.privacyManager.getConsentStatus()}async requestConsent(){return await this.privacyManager.requestConsent({showBanner:!0})}optOut(){this.stopDetection(),this.privacyManager.optOut(),this.config.debug}async optIn(){const t=await this.privacyManager.optIn();return t&&(this.startDetection(),this.config.debug),t}deleteUserData(){this.stopDetection(),this.privacyManager.clearStoredData(),this.userEmail=null,this.config.debug}getStatus(){const t={version:this.version,initialized:this.initialized,detecting:this.isDetecting,hasConsent:this.privacyManager.hasConsent(),hasUserEmail:!!this.userEmail,detectors:{}};return Object.keys(this.detectors).forEach(e=>{const i=this.detectors[e];i&&i.getStatus&&(t.detectors[e]=i.getStatus())}),t}updateConfig(t={}){this.config={...this.config,...t},(t.baseURL||t.apiKey)&&this.apiClient.updateConfig({baseURL:t.baseURL,apiKey:t.apiKey}),Object.values(this.detectors).forEach(e=>{e&&e.updateConfig&&e.updateConfig(t)}),this.config.debug}dispatchEvent(t,e={}){try{const i=new CustomEvent(`pavekit-${t}`,{detail:{timestamp:(new Date).toISOString(),version:this.version,...e}});window.dispatchEvent(i)}catch(t){}}getDebugInfo(){return{version:this.version,config:this.config,status:this.getStatus(),browserSupport:this.securityUtils.isBrowserSupported(),privacy:this.privacyManager.getConsentStatus(),apiClient:this.apiClient.getStatus(),compliance:this.securityUtils.getComplianceInfo()}}reset(){this.stopDetection(),this.privacyManager.reset(),this.apiClient.reset(),this.userEmail=null,this.initialized=!1,this.config.debug}}"undefined"!=typeof window&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{PaveKitSDK.autoInit()}):"undefined"!=typeof window&&setTimeout(()=>{PaveKitSDK.autoInit()},0);var c=PaveKitSDK;return"undefined"!=typeof window&&(window.PaveKitSDK=PaveKitSDK),e=e.default}()});
//# sourceMappingURL=pavekit.min.js.map