name: Build and Release SDK

on:
  push:
    branches:
      - master
    paths:
      - "src/**"
  workflow_dispatch:
    inputs:
      version:
        description: "Version to release (leave empty for auto-increment)"
        required: false
        type: string
      release_type:
        description: "Release type"
        required: true
        default: "patch"
        type: choice
        options:
          - patch
          - minor
          - major

env:
  CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
  CLOUDFLARE_R2_BUCKET: ${{ secrets.CLOUDFLARE_R2_BUCKET || 'pavekit-sdk' }}

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Run tests
        run: npm test

      - name: Build SDK
        run: npm run build

      - name: Check bundle size
        run: npm run size

      - name: Get version info
        id: version
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")

          if [ -n "${{ github.event.inputs.version }}" ]; then
            NEW_VERSION="${{ github.event.inputs.version }}"
          else
            # Auto-increment based on release_type
            RELEASE_TYPE="${{ github.event.inputs.release_type || 'patch' }}"
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR="${VERSION_PARTS[0]}"
            MINOR="${VERSION_PARTS[1]}"
            PATCH="${VERSION_PARTS[2]}"

            case $RELEASE_TYPE in
              major)
                MAJOR=$((MAJOR + 1))
                MINOR=0
                PATCH=0
                ;;
              minor)
                MINOR=$((MINOR + 1))
                PATCH=0
                ;;
              patch)
                PATCH=$((PATCH + 1))
                ;;
            esac

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          fi

          echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version-tag=v$NEW_VERSION" >> $GITHUB_OUTPUT

          # Extract major and minor for later use
          IFS='.' read -ra VERSION_PARTS <<< "$NEW_VERSION"
          MAJOR="${VERSION_PARTS[0]}"
          MINOR="${VERSION_PARTS[1]}"
          echo "major=$MAJOR" >> $GITHUB_OUTPUT
          echo "minor=$MINOR" >> $GITHUB_OUTPUT

      - name: Update version in package.json
        if: github.event_name == 'workflow_dispatch'
        run: |
          npm version ${{ steps.version.outputs.new-version }} --no-git-tag-version

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist-${{ steps.version.outputs.new-version }}
          path: ./dist/
          retention-days: 7

    outputs:
      new-version: ${{ steps.version.outputs.new-version }}
      major: ${{ steps.version.outputs.major }}
      minor: ${{ steps.version.outputs.minor }}
      version-tag: ${{ steps.version.outputs.version-tag }}

  deploy:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch'
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist-${{ needs.build.outputs.new-version }}
          path: ./dist/

      - name: Install wrangler
        run: npm install -g wrangler

      - name: Deploy to Cloudflare R2
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "üöÄ Starting deployment to Cloudflare R2"
          echo "Bucket: ${{ env.CLOUDFLARE_R2_BUCKET }}"
          echo "Version: ${{ needs.build.outputs.new-version }}"

          # Verify file exists
          if [ ! -f ./dist/pavekit.min.js ]; then
            echo "‚ùå Error: pavekit.min.js not found in dist/"
            ls -la ./dist/
            exit 1
          fi

          echo "‚úÖ Found pavekit.min.js ($(du -h ./dist/pavekit.min.js | cut -f1))"

          # Create version directory
          mkdir -p versioned
          cp ./dist/pavekit.min.js ./versioned/

          echo "üì¶ Uploading versioned file..."
          # Upload versioned file
          wrangler r2 object put ${{ env.CLOUDFLARE_R2_BUCKET }}/v${{ needs.build.outputs.new-version }}/pavekit-sdk.min.js --file=./versioned/pavekit.min.js
          echo "‚úÖ Uploaded v${{ needs.build.outputs.new-version }}"

          echo "üì¶ Uploading as latest..."
          # Upload as latest
          wrangler r2 object put ${{ env.CLOUDFLARE_R2_BUCKET }}/latest/pavekit-sdk.min.js --file=./versioned/pavekit.min.js
          echo "‚úÖ Uploaded latest"

          echo "üì¶ Uploading semantic version aliases..."
          # Create semantic version aliases
          MAJOR_VERSION=${{ needs.build.outputs.major }}
          MINOR_VERSION="${{ needs.build.outputs.major }}.${{ needs.build.outputs.minor }}"

          wrangler r2 object put ${{ env.CLOUDFLARE_R2_BUCKET }}/v${{ needs.build.outputs.major }}/pavekit-sdk.min.js --file=./versioned/pavekit.min.js
          echo "‚úÖ Uploaded v${{ needs.build.outputs.major }}"

          wrangler r2 object put ${{ env.CLOUDFLARE_R2_BUCKET }}/v${{ needs.build.outputs.major }}.${{ needs.build.outputs.minor }}/pavekit-sdk.min.js --file=./versioned/pavekit.min.js
          echo "‚úÖ Uploaded v${{ needs.build.outputs.major }}.${{ needs.build.outputs.minor }}"

          echo "üéâ All files uploaded successfully!"

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Update versions.json
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Try to get existing versions, create new if doesn't exist
          if wrangler r2 object get ${{ env.CLOUDFLARE_R2_BUCKET }}/versions.json > existing-versions.json 2>/dev/null; then
            echo "‚úÖ Found existing versions.json"
            # Validate it's valid JSON
            if ! jq empty existing-versions.json 2>/dev/null; then
              echo "‚ö†Ô∏è Invalid JSON in versions.json, creating new file"
              echo '{"versions":[],"latest":""}' > existing-versions.json
            fi
          else
            echo "üìù No versions.json found, creating new file"
            echo '{"versions":[],"latest":""}' > existing-versions.json
          fi

          # Update with new version
          NEW_VERSION='${{ needs.build.outputs.new-version }}'
          jq --arg version "$NEW_VERSION" '.versions += [$version] | .versions |= unique | .latest = $version' existing-versions.json > new-versions.json

          # Upload updated versions file
          wrangler r2 object put ${{ env.CLOUDFLARE_R2_BUCKET }}/versions.json --file=new-versions.json

          echo "‚úÖ Updated versions.json with version $NEW_VERSION"

  release:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Update version and push tag
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

          # Update version in package.json
          npm version ${{ needs.build.outputs.new-version }} --no-git-tag-version

          # Commit version change
          git add ./package.json
          git commit -m "chore: bump SDK version to ${{ needs.build.outputs.new-version }}"

          # Create and push tag
          git tag ${{ needs.build.outputs.version-tag }}
          git push origin master --tags

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.build.outputs.version-tag }}
          release_name: PaveKit SDK v${{ needs.build.outputs.new-version }}
          body: |
            ## Changes in v${{ needs.build.outputs.new-version }}

            ### Installation
            ```html
            <!-- Latest version -->
            <script src="https://cdn.pavekit.com/latest/pavekit-sdk.min.js"></script>

            <!-- Specific version -->
            <script src="https://cdn.pavekit.com/v${{ '' }}${{ needs.build.outputs.new-version }}/pavekit-sdk.min.js"></script>
            ```

            ### CDN URLs
            - Latest: https://cdn.pavekit.com/latest/pavekit-sdk.min.js
            - Version ${{ '' }}${{ needs.build.outputs.new-version }}: https://cdn.pavekit.com/v${{ '' }}${{ needs.build.outputs.new-version }}/pavekit-sdk.min.js
            - Major version (v${{ '' }}${{ needs.build.outputs.major }}): https://cdn.pavekit.com/v${{ '' }}${{ needs.build.outputs.major }}/pavekit-sdk.min.js
            - Minor version (v${{ '' }}${{ needs.build.outputs.major }}.${{ '' }}${{ needs.build.outputs.minor }}): https://cdn.pavekit.com/v${{ '' }}${{ needs.build.outputs.major }}.${{ '' }}${{ needs.build.outputs.minor }}/pavekit-sdk.min.js
          draft: false
          prerelease: false

  publish-npm:
    runs-on: ubuntu-latest
    needs: [build, deploy]
    if: github.event_name == 'workflow_dispatch'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"
          cache-dependency-path: "./package-lock.json"

      - name: Install dependencies
        run: npm ci

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist-${{ needs.build.outputs.new-version }}
          path: ./dist/

      - name: Update version in package.json
        run: npm version ${{ needs.build.outputs.new-version }} --no-git-tag-version

      - name: Generate TypeScript definitions
        run: npm run build:types

      - name: Verify package contents
        run: |
          echo "üì¶ Package contents that will be published:"
          npm pack --dry-run
          echo ""
          echo "üìÅ Dist directory contents:"
          ls -lh ./dist/
          echo ""
          echo "‚úÖ Ready to publish version ${{ needs.build.outputs.new-version }}"

      - name: Publish to NPM
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
